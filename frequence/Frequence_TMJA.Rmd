---
title: "Frequence_TMJA"
output:
  pdf_document: default
  html_document: default
date: "2025-12-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
#Quelques packages qu'on a utilisé ci-dessous
library(dplyr)   # Pour manipuler les données
library(MASS)    # Pour la loi Binomiale Négative (glm.nb)
library(ggplot2) # Pour les graphes
library(readxl) # pour lire un fichier .xls
```

## A) CSV "nettoyé"

Pour déterminer la fréquences des accidents avec TMJA, notre méthode est la suivante : on part des accidents individuels (données de l'ONISR) puis on les regroupes par ville (df_communes) ensuite, on calcule TMJA moyen par département (df_tmja_dep) et ensuite on met tout dans df_final

```{r}

df_accidents <- read.csv("../data/ONISR-2021.csv", 
                         sep = ",", 
                         stringsAsFactors = FALSE)

print(head(names(df_accidents)))

# --- 2. FONCTION DE NETTOYAGE ---
clean_dep <- function(d) {
  d <- as.character(d)
  # Si le code a 3 chiffres et finit par 0 (ex: 380), on garde les 2 premiers
  ifelse(nchar(d) == 3 & substr(d, 3, 3) == "0", substr(d, 1, 2), d)
}


df_clean <- df_accidents %>%
  mutate(dep_clean = clean_dep(dep))

# Vérification
print(unique(head(df_clean$dep_clean)))
```

Icin on

## B) Filtre région Auvergne-Rhône-Alpes et dataset final

```{r}
# 1. Liste des codes départements AURA
# On met "1" et "01" pour être sûr de tout attraper selon le formatage
lista_AURA <- c("1", "01", "3", "03", "7", "07", "15", "26", "38", "42", "43", "63", "69", "73", "74")


df_AURA <- df_clean %>%
  filter(as.character(dep_clean) %in% lista_AURA)
```

df_AURA est df_accidents et on a gardé uniquement le département Auvergne Rhône-Alpes

Ici, 1 ligne = 1 accident

```{r}
library(dplyr)

df_communes <- df_AURA %>%
  group_by(dep_clean, com) %>%
  summarise(
    Nb_Accidents = n(),
    
    Part_Pluie = mean(grepl("pluie", atm, ignore.case = TRUE), na.rm = TRUE),
    
    Part_Neige = mean(grepl("neige", atm, ignore.case = TRUE), na.rm = TRUE),
    
    Part_Virage = mean(!grepl("rectiligne", plan, ignore.case = TRUE), na.rm = TRUE),
    
    Part_Nuit = mean(!grepl("plein jour", lum, ignore.case = TRUE), na.rm = TRUE),
    
    # Coordonnées pour la carte
    lat_center = mean(lat, na.rm = TRUE),
    long_center = mean(long, na.rm = TRUE),
    
    .groups = 'drop'
  )
```

df_communes (L'agrégation) ON change l'échelle, donc on regroupe tout par communes et on veut prédire le "risque par ville" (ex : avant 10 lignes pour 10 accidents à Grenoble mtn uniquement 1 ligne par accident à Grenoble )

Cela correspond à la colonne Nb_Accidents dans l'entête

```{r}

df_tmja_brut <- read_excel("tmja_2021_intranet.xls", sheet = 2)


df_tmja_dep <- df_tmja_brut %>%
  dplyr::select(dep_source = 13, Valeur_TMJA = 19) %>%
  
  mutate(dep_clean = as.character(as.integer(dep_source))) %>%
  filter(dep_clean %in% lista_AURA) %>%
  group_by(dep_clean) %>%
  summarise(
    Trafic_Moyen = mean(Valeur_TMJA, na.rm = TRUE)
  )
#On fusionne
df_communes <- df_communes %>%
  left_join(df_tmja_dep, by = "dep_clean")
print("TMJA ajouté avec succès via les indices de colonnes !")

#Df_final qu'on va utiliser
df_final <- df_communes %>%
  filter(!is.na(Trafic_Moyen))
```

df_tmja_brut correspond au fichier Excel téléchargés sur le site du TMJA

df_tmja_dep (le résumé) : comme on ne peut pas coller le trafic sur chaque rue, on a calculé la moyenne.

Ainsi, on a transformé l'Excel en un petit tableau simple :

-   Département 38 (Isère) -\> Trafic Moyen = X véhicules/jour.

-   Département 15 (Cantal) -\> Trafic Moyen = Y véhicules/jour.

## C) Test

A présent, que le dataset est bien fiable, organisé et bien propre, on va réaliser tous nos test sur df_final

```{r}
modele_poisson <- glm(Nb_Accidents ~ Part_Pluie + Part_Neige + Part_Virage + Part_Nuit + 
                      offset(log(Trafic_Moyen)), 
                      family = poisson, 
                      data = df_final)

summary(modele_poisson)
```

```{r}
modele_binomiale_négative <- glm.nb(Nb_Accidents ~ Part_Pluie + Part_Neige + Part_Virage + Part_Nuit + 
                         offset(log(Trafic_Moyen)), 
                         data = df_final)
summary(modele_binomiale_négative)
```

```{r}
aic_poisson <- AIC(modele_poisson)
aic_nb <- AIC(modele_binomiale_négative) 
cat("AIC Poisson            :", round(aic_poisson, 2), "\n")
cat("AIC Binomiale Négative :", round(aic_nb, 2), "\n")
```

A nouveau même à une échelle régionale le modèle Binomiale négative est plus intéressant que le modèle de Poisson

```{r}
ratios <- exp(coef(modele_binomiale_négative)) 
print(ratios)
```

D'une part, **La nuit** (coef 1.64) apparait comme un facteur aggravant majeur qui augmente le risque de 64% à trafic constant, en raison de la visibilité réduite et de la fatigue. D'autre part, **La neige**(0.61) et **les virages** (0.23) présentent des coefficients inférieurs à 1, ce qui suggère un effet "protecteur" contre-intuitif. Ce paradoxe apparent s'explique par une forte adaptation comportomentale. Face à des conditions visiblement difficiles (routes de montagne, intempéries), les conducteurs augmentent leur vigilance et réduisent leur vitesse, alors que les environnements jugés "sûrs" favorisent le relâchement de l'attention.

## D) Apercu visuel sur la carte de France

```{r}
library(ggplot2)
library(dplyr)
library(stringr)
df_map_source <- df_AURA

if("latitude" %in% names(df_map_source)) df_map_source <- rename(df_map_source, lat = latitude)
if("longitude" %in% names(df_map_source)) df_map_source <- rename(df_map_source, long = longitude)

df_map_source$lat <- as.numeric(gsub(",", ".", as.character(df_map_source$lat)))
df_map_source$long <- as.numeric(gsub(",", ".", as.character(df_map_source$long)))

# Calcul des centres par communes
coords_communes <- df_map_source %>%
  filter(!is.na(lat) & !is.na(long)) %>% 
  group_by(dep_clean, com) %>%
  summarise(
    lat_center = mean(lat, na.rm = TRUE),
    long_center = mean(long, na.rm = TRUE),
    .groups = 'drop'
  )
df_final_clean <- df_final %>% 
  dplyr::select(-any_of(c("lat_center", "long_center")))

# On colle les nouvelles coordonnées propres
df_map <- df_final_clean %>%
  inner_join(coords_communes, by = c("dep_clean", "com"))

print(paste("Nombre de communes prêtes à être affichées :", nrow(df_map)))
```

```{r}
# --- 4. LA CARTE (VIRAGES) ---
# Calcul du zoom automatique
min_x <- min(df_map$long_center, na.rm = TRUE) - 0.2
max_x <- max(df_map$long_center, na.rm = TRUE) + 0.2
min_y <- min(df_map$lat_center, na.rm = TRUE) - 0.2
max_y <- max(df_map$lat_center, na.rm = TRUE) + 0.2

ggplot(df_map, aes(x = long_center, y = lat_center)) +
  # Fond de carte
  borders("france", colour = "grey90", fill = "white") +
  
  # Les points (Part_Virage)
  geom_point(aes(size = Nb_Accidents, color = Part_Virage), alpha = 0.7) +
  
  # Couleurs : Bleu (Plat) -> Rouge (Virage)
  scale_color_gradient(low = "grey85", high = "#e31a1c", name = "% Virages",
                       limits = c(0, 1)) +
  
  # Taille
  scale_size_continuous(range = c(0.5, 6), name = "Vol. Accidents") +
  
  # Zoom
  coord_quickmap(xlim = c(min_x, max_x), ylim = c(min_y, max_y)) +
  
  # Titres
  labs(title = "Géographie du Risque : Virages vs Lignes Droites",
       subtitle = "Bleu = Plaine | Rouge = Montagne",
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```

CARTE PART_NUIT

```{r}
ggplot(df_map, aes(x = long_center, y = lat_center)) +
  # Fond
  borders("france", colour = "grey90", fill = "white") +
  
  geom_point(aes(size = Nb_Accidents, color = Part_Nuit), alpha = 0.7) +
  
 
  scale_color_gradient(low = "grey85", high = "#a50f15", name = "% Nuit",
                       limits = c(0, 1)) +
  
  scale_size_continuous(range = c(0.5, 6), name = "Vol. Accidents") +
  coord_quickmap(xlim = c(min_x, max_x), ylim = c(min_y, max_y)) +
  
  labs(title = "Géographie des horaires : Jour vs Nuit",
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```

```{r}
ggplot(df_map, aes(x = long_center, y = lat_center)) +
  borders("france", colour = "grey90", fill = "white") +
  
  geom_point(aes(size = Nb_Accidents, color = Part_Pluie), alpha = 0.7) +
  
  scale_color_gradient(low = "grey85", high = "#08519c", name = "% Pluie",
                       limits = c(0, 1)) +
  
  scale_size_continuous(range = c(0.5, 6), name = "Vol. Accidents") +
  coord_quickmap(xlim = c(min_x, max_x), ylim = c(min_y, max_y)) +
  
  labs(title = "Facteur Météo : La Pluie",
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```

```{r}
ggplot(df_map, aes(x = long_center, y = lat_center)) +
  borders("france", colour = "grey90", fill = "white") +
  
  geom_point(aes(size = Nb_Accidents, color = Part_Neige), alpha = 0.7) +
  
  scale_color_gradient(low = "grey85", high = "#00BFFF", name = "% Neige",
                       limits = c(0, 1)) +
  
  scale_size_continuous(range = c(0.5, 6), name = "Vol. Accidents") +
  coord_quickmap(xlim = c(min_x, max_x), ylim = c(min_y, max_y)) +
  
  labs(title = "Facteur Météo : La Neige (Événement rare)",
       x = "Longitude", y = "Latitude") +
  theme_minimal()
```
