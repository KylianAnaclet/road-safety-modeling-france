---
title: "Analyse des Facteurs de Gravité des Accidents Routiers (ONISR 2021)"
subtitle: "Régression linéaire"
output:
  pdf_document:
    toc: true
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width=8, fig.height=4)
```

```{r}
# Chargement des librairies utiles
if(!require(dplyr)) install.packages("dplyr")
if(!require(stringr)) install.packages("stringr")
if(!require(car)) install.packages("car")
if(!require(ggplot2)) install.packages("ggplot2")
library(dplyr)
library(stringr)
library(car)
library(ggplot2)
```

# Introduction

L'objectif est de déterminer les facteurs qui ont le plus d'impact sur la sévérité d'un accident de la route en France en 2021. Nous cherchons donc à expliquer un **Score de Sévérité** à partir de variables issues de la base de données ONISR 2021 (Observatoire National Interministériel de la Sécurité Routière).




# Préparation des Données


## Importation et Nettoyage

```{r}
df <- read.csv("ONISR-2021.csv")
head(df)
```

Pour le traitement des données, nous allons commencer par définir un **Score de Sévérité** pondéré par le nombre de tué, hospitalisé et blessé. Cette pondération est basé sur l'échelle AIS (Abbreviated Injury Scale); 1 pour une blessure légère, 3 pour une blessure sérieuse et 6 pour une blessure maximale.

```{r}
# On ajoute ce score de sévérité dans notre df
df <- df %>%
  mutate(
    Score_Severite = 1*nb_blesse + 3*nb_hospitalise + 6*nb_tue,
  )

colnames(df)
```


```{r}
# Histogramme du score de sévérité

df %>%
  # Séparation du score en fonction de la gravité
  mutate(Tranche_Gravite = case_when(
    Score_Severite <= 2 ~ "1. Léger (0-2)",       
    Score_Severite <= 4 ~ "2. Intermédiaire (3-4)", 
    Score_Severite >= 5 ~ "3. Grave (5+)"                        
  )) %>%
  
  
  ggplot(aes(x = Score_Severite)) +
  
  # On utilise la nouvelle colonne 'Tranche_Gravite' pour la couleur (fill)
  geom_bar(aes(fill = Tranche_Gravite), 
           width = 1, 
           color = "black", 
           alpha = 0.9) +

  scale_fill_manual(values = c(
    "1. Léger (0-2)" = "#69b3a2",        
    "2. Intermédiaire (3-4)" = "#F39C12", 
    "3. Grave (5+)" = "#C0392B"          
  )) +
  
  # Axe des x gradués de 1 par 1 jusqu'à 10
  scale_x_continuous(breaks = seq(0, 10, by = 1)) +
  coord_cartesian(xlim = c(0, 10)) +
  
  labs(title = "Distribution du Score de Sévérité",
       x = "Score de Sévérité", 
       y = "Nombre d'accidents",
       fill = "Niveau de gravité") + 
  
  theme_minimal() +
  theme(plot.title = element_text(size = 20, hjust = 0.5),
        legend.position = "top") 

```


```{r}
library(ggplot2)
library(dplyr)
library(scales) # Pour le formatage des %

# Calcul des %
df_pie <- df %>%
  # On recrée les catégories
  mutate(Tranche_Gravite = case_when(
    Score_Severite <= 2 ~ "1. Léger (0-2)",        
    Score_Severite <= 4 ~ "2. Intermédiaire (3-4)", 
    Score_Severite >= 5 ~ "3. Grave (5+)"                           
  )) %>%
  # On compte le nombre d'accidents par catégorie
  count(Tranche_Gravite) %>%
  # On calcule le pourcentage
  mutate(prop = n / sum(n),
         label_percent = percent(prop, accuracy = 0.1)) # Formatage "12.5%"

# CRÉATION DU CAMEMBERT
ggplot(df_pie, aes(x = "", y = prop, fill = Tranche_Gravite)) +
  
  # Création des parts (barre unique empilée)
  geom_bar(stat = "identity", width = 2, color = "white") +
  
  # Transformation en cercle 
  coord_polar("y", start = 0) +
  
  # Ajout du texte (Pourcentages) au milieu des parts
  geom_text(aes(label = label_percent), 
            position = position_stack(vjust = 0.5), 
            color = "white", fontface = "bold", size = 4) +
  
  
  scale_fill_manual(values = c(
    "1. Léger (0-2)" = "#69b3a2",        
    "2. Intermédiaire (3-4)" = "#F39C12", 
    "3. Grave (5+)" = "#C0392B"          
  )) +
  
  # Titres
  labs(title = "Répartition des accidents par Gravité",
       fill = "Niveau de gravité") + # Titre de la légende
  
  # Thème vide (indispensable pour un beau pie chart)
  theme_void() +
  theme(
    plot.title = element_text(size = 18, face = "bold", hjust = 0.5, margin = margin(b = 20)),
    legend.position = "right",
    legend.title = element_text(face = "bold")
  )
```

```{r}
summary(df$Score_Severite)
```


```{r}
str(df)
```
On observe qu'un certain nombre de variables ne nous sera pas utile pour notre modèle de régression pour différentes raisons. En effet, les variables qui servent d'identifiants, celles ayant trop de catégories ou encore les variables avec une grande proportion de valeurs manquantes. 
Pour les variables ayant trop de modalités, il est préférable de regrouper les différentes modalités car juste supprimer ces variables pourrait faire perdre beacoup d'informations pour notre modèle.

```{r}
# On crée donc une fonction permettant de regrouper les départements (+100) en régions (13 métropolitaine + 1 pour l'Outre-Mer)

get_region <- function(dep_code) {
  # On s'assure que l'entrée est un chr
  d <- as.character(dep_code)
  
  case_when(
    # Gestion de la Corse (2A et 2B)
    d %in% c("2A", "2B", "20") ~ "Corse",
    
    # Gestion des DOM (codes commençant par 97)
    substr(d, 1, 2) == "97" ~ "Outre-Mer",
    
    # Départements standards (on gère les cas "1" et "01")
    # Auvergne-Rhône-Alpes
    d %in% c("01", "1", "03", "3", "07", "7", "15", "26", "38", "42", "43", "63", "69", "73", "74") ~ "Auvergne-Rhône-Alpes",
    
    # Hauts-de-France
    d %in% c("02", "2", "59", "60", "62", "80") ~ "Hauts-de-France",
    
    # PACA
    d %in% c("04", "4", "05", "5", "06", "6", "13", "83", "84") ~ "PACA",
    
    # Grand Est
    d %in% c("08", "8", "10", "51", "52", "54", "55", "57", "67", "68", "88") ~ "Grand Est",
    
    # Occitanie
    d %in% c("09", "9", "11", "12", "30", "31", "32", "34", "46", "48", "65", "66", "81", "82") ~ "Occitanie",
    
    # Normandie
    d %in% c("14", "27", "50", "61", "76") ~ "Normandie",
    
    # Nouvelle-Aquitaine
    d %in% c("16", "17", "19", "23", "24", "33", "40", "47", "64", "79", "86", "87") ~ "Nouvelle-Aquitaine",
    
    # Centre-Val de Loire
    d %in% c("18", "28", "36", "37", "41", "45") ~ "Centre-Val de Loire",
    
    # Bourgogne-Franche-Comté
    d %in% c("21", "25", "39", "58", "70", "71", "89", "90") ~ "Bourgogne-Franche-Comté",
    
    # Bretagne
    d %in% c("22", "29", "35", "56") ~ "Bretagne",
    
    # Pays de la Loire
    d %in% c("44", "49", "53", "72", "85") ~ "Pays de la Loire",
    
    # Île-de-France
    d %in% c("75", "77", "78", "91", "92", "93", "94", "95") ~ "Île-de-France"
  )
}
```


```{r}
df <- df %>%
  
  # On transforme l'heure en un numeric compris entre 0 et 23
  # en extrayant la première partie de hrmn (heure:min)
  mutate(
    Heure_Num= as.numeric(str_sub(hrmn, 1, 2))
  ) %>%
  
  # On crée une variable Moment pour séparer les moments de la journée
  mutate(
    Moment = case_when(
      Heure_Num >= 0 & Heure_Num <= 5  ~ "Nuit Profonde",
      Heure_Num >= 6 & Heure_Num <= 10 ~ "Matin (Pointe)",
      Heure_Num >= 11 & Heure_Num <= 16 ~ "Journee (Creuse)",
      Heure_Num >= 17 & Heure_Num <= 21 ~ "Soir (Pointe)",
      Heure_Num >= 22 & Heure_Num <= 23 ~ "Soiree",
      TRUE ~ "Autre" # Sécurité
    ),
    # On transforme en factor et on choisit "Journée" comme référence
    Moment = factor(Moment, levels = c("Journee (Creuse)", "Matin (Pointe)", "Soir (Pointe)", "Soiree", "Nuit Profonde")))%>%
  
  # On crée la colonne région
  mutate(
    Region = get_region(dep),
    Region = as.factor(Region)
  ) %>%
  
  # On garde que les variables intéressantes i.e
  # en enlevant les identifiants (Num_Acc, adr), les variables quasi vides (pr, lartpc..), ou avec trop de catégories (com, dep)
  select(
    Score_Severite,
    Region,
    Moment,
    lum, agg, int, atm, col, 
    catr, circ, prof, plan, surf, infra, situ, 
    vma, 
    nb_velo, nb_moto, nb_voiture, nb_utilitaire, nb_camion, nb_transport
  ) %>%
  
    
  # On convertit les variables chr en factor pour que r les traitent comme des variables qualitatives
  mutate_if(is.character, as.factor) %>%
  
  # On supprime les lignes avec des valeurs manquantes
  na.omit
```


```{r}
str(df)
```
Après ce nettoyage, on a perdu seulement environ 4 000 lignes, ce qui est négligeable puisqu'il nous reste 52 000 lignes et nous avons gagné en qualité.

```{r}
# R crée des levels pour les variables factor afin de comparer ces levels par rapport à un level de référence (Intercept).
# Mais initialement R choisit le level de référence par ordre alphabétique, ce qui n'est pas forcément souhaitable 
```

```{r}
# Par exemple, R a choisit la référence "aube ou crépuscule" alors qu'on voudrait mieux comparer par rapport à la référence "plein jour"
levels(df$lum)
```

```{r}
# On affecte le level de référence que l'on souhaite
df$lum <- relevel(df$lum, ref = "plein jour", silent=TRUE)
df$atm <- relevel(df$atm, ref = "normale", silent=TRUE)
df$prof <- relevel(df$prof, ref = "plat", silent=TRUE)
df$plan <- relevel(df$plan, ref = "rectiligne", silent=TRUE)
df$surf <- relevel(df$surf, ref = "normale", silent=TRUE)
df$int <- relevel(df$int, ref = "aucune", silent=TRUE)
df$catr <- relevel(df$catr, ref = "departementale", silent=TRUE)
df$situ <- relevel(df$situ, ref = "chaussee", silent=TRUE)
df$col <- relevel(df$col, ref = "sans", silent=TRUE)
```

```{r}
# Vérifions 
cat("Référence pour LUM :", levels(df$lum)[1], "\n")
cat("Référence pour ATM :", levels(df$atm)[1], "\n")
cat("Référence pour PROF :", levels(df$prof)[1], "\n")
cat("Référence pour PLAN :", levels(df$plan)[1], "\n")
cat("Référence pour SURF :", levels(df$surf)[1], "\n")
cat("Référence pour INT :", levels(df$int)[1], "\n")
cat("Référence pour CATR :", levels(df$catr)[1], "\n")
cat("Référence pour SITU :", levels(df$situ)[1], "\n")
```

Ainsi, lorsque l'on va calculer la régression, Intercept correspondra au score de sévérité moyen quand tout est à la référence (Plein jour, Météo normale, route plate, etc.)

# Modèle de Régression Linéaire

## Modèle 1
```{r}
# Modèle de régression: Score de sévérité expliqué par toutes les colonnes
modele <- lm(Score_Severite ~ ., data = df)

summary(modele)
```
```{r}


# On affiche les 4 graphiques de diagnostic
plot(modele)


```
1) Les résidus sont globalement centré autour de 0 mais on observe une augmentation de la dispersion des résidus pour les valeurs élevées.
2) Les points suivent approximativement la droite normale théorique mais pour les valeurs élevées, les points s'écartent de la droite. Cela indique que les résidus ne suivent pas une distribution normale.
3) La variabilité des résidus augmente avec les valeurs prédites par le modèle (courbe rouge croissante)
4) On identifie un point extrême tout à droite
```{r}
# Distribution des résidus
hist(resid(modele), 
     breaks = 50, 
     col = "lightblue", 
     main = "Distribution des Résidus",
     xlab = "Erreur du modèle")
```
On peut observer un pic autour de 0 et une asymétrie positive, qui confirme visuellement la non-normalité des résidus.


## Modèle 2
On a vu que dans la distribution du score de sévérité, il y avait beaucoup d'accidents légers et quelques accidents très graves. Appliquer le log à ce score permet de limiter les scores extrêmes et de rapprocher la distribution empirique d'une loi Normale. 
```{r}
# Modèle de régression avec le log: Score de sévérité expliqué par toutes les colonnes
modele2 <- lm(log(Score_Severite+1) ~ ., data = df) #On ajoute le +1 si score =0

summary(modele2)
```

```{r}
plot(modele2)
```
Les points suivent désormais presque parfaitement la droite normale. Cela signifie que l'hypothèse de normalité des résidus est respectée.

```{r}
hist(resid(modele2), 
     breaks = 20, 
     col = "lightblue", 
     main = "Distribution des Résidus",
     xlab = "Erreur du modèle")
```
Graphique un peu plus en forme de cloche qui fait penser à la loi Normale.

## Modèle 3
On enlève les variables surf, prof et circ de notre modèle car ces variables ne sont statistiquement pas significatives au seuil 5% sur le score de sévérité (test de Student avec H0: coefficient nul).
```{r}
modele3 <- lm(log(Score_Severite+1) ~. - surf - prof-circ, data=df)
summary(modele3)
```
Le modèle linéaire explique 23,3% de la variabilité du score de sévérité.

# Facteurs les plus influents sur la gravité

```{r}
# Variables qui ont le plus d'impact sur la sévérité
coefs <- modele3$coefficients[-1] #on enlève l'intercept
tri_coefs <- coefs[order(abs(coefs), decreasing = TRUE)]
head(tri_coefs, 8)
```
```{r}

library(dplyr)
library(ggplot2)
library(broom)



# On prend la valeur absolue (abs) pour avoir les facteurs les plus INFLUENTS (positifs ou négatifs)

coef_df <- tidy(modele3) %>%
  filter(term != "(Intercept)") %>%
  arrange(desc(abs(estimate))) %>%
  head(8) %>% # On en garde 8 
  mutate(
    Type_Influence = ifelse(estimate > 0, "Aggravant", "Protecteur"), # Pour la couleur
  )


ggplot(coef_df, aes(x = reorder(term, estimate), y = estimate, fill = Type_Influence)) +
  

  geom_col(width = 0.6, alpha = 0.9) + 
  
  # Ajout des valeurs au bout des barres
  geom_text(aes(label = round(estimate, 3)), 
            hjust = ifelse(coef_df$estimate > 0, -0.2, 1.2), # Ajuste la position selon le signe
            fontface = "bold", color = "grey30") +
  
  coord_flip() + # On met à l'horizontale
  
 
  scale_fill_manual(values = c("Aggravant" = "#E74C3C", "Protecteur" = "#2ECC71")) +
  scale_y_continuous(limits = c(min(coef_df$estimate) * 1.3, 0.3)) +
  # Titres et Axes
  labs(title = "Facteurs les plus influents sur la Gravité",
      
       x = "", y = "Coefficients") +
  
  
  theme_classic() +
  theme(
    legend.position = "top",
    legend.title = element_blank(),
    axis.text.y = element_text(size = 11, face = "bold"),
    axis.line.y = element_blank(), # Enlève la ligne verticale moche
    plot.title = element_text(face = "bold", size = 16)
  )
```
Les accidents hors agglomération sont en moyenne 20% ($\text{e}(0.181) -1 = 0.198$) plus graves que ceux en agglomération.

Une collision frontale entre deux véhicules augmente le score de sévérité d'environ 19% par rapport aux accidents sans collision.

Les accidents sur l'autoroute sont en moyenne 20% ($\text{e}(-0.223)-1 = -0.199$) moins graves que les accidents sur une départementale.

Les accidents en Ile-de-France sont en moyenne 17% moins graves que les accidents en Auverge-Rhône-Alpes.

Remarque: Ces interprétations se font toute choses égales par ailleurs, les autres variables étant constantes. Et la gravité de l'accident est jugé selon notre score de sévérité.



