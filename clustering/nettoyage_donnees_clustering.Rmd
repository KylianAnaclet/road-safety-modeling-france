---
title: "nettoyage_donnees_clustering"
output: html_document
date: "2025-12-16"
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Ce script a pour objectif de nettoyer et de structurer les données
d’accidents de la route issues de l’ONISR pour l’année 2021. Il enrichit
les données par la création d’un score de sévérité, la classification
des accidents selon le moment de la journée et le regroupement des
départements en régions, afin d’obtenir une base de données exploitable
pour la méthode de parititionnement (clustering).

```{r}
df <- read.csv("../data/ONISR-2021.csv")
```

```{r}
#librairies pour Pipe (%>%) et manipuler des strings
if(!require(dplyr)) install.packages("dplyr")
if(!require(stringr)) install.packages("stringr")
library(dplyr)
library(stringr)
```

```{r}
# Création d'une fonction pour regrouper les départements par régions

get_region <- function(dep_code) {
  # On s'assure que l'entrée est un chr
  d <- as.character(dep_code)
  
  case_when(
    # Gestion de la Corse (2A et 2B)
    d %in% c("2A", "2B", "20") ~ "Corse",
    
    # Gestion des DOM (codes commençant par 97)
    substr(d, 1, 2) == "97" ~ "Outre-Mer",
    
    # Départements standards (on gère les cas "1" et "01")
    # Auvergne-Rhône-Alpes
    d %in% c("01", "1", "03", "3", "07", "7", "15", "26", "38", "42", "43", "63", "69", "73", "74") ~ "Auvergne-Rhône-Alpes",
    
    # Hauts-de-France
    d %in% c("02", "2", "59", "60", "62", "80") ~ "Hauts-de-France",
    
    # PACA
    d %in% c("04", "4", "05", "5", "06", "6", "13", "83", "84") ~ "PACA",
    
    # Grand Est
    d %in% c("08", "8", "10", "51", "52", "54", "55", "57", "67", "68", "88") ~ "Grand Est",
    
    # Occitanie
    d %in% c("09", "9", "11", "12", "30", "31", "32", "34", "46", "48", "65", "66", "81", "82") ~ "Occitanie",
    
    # Normandie
    d %in% c("14", "27", "50", "61", "76") ~ "Normandie",
    
    # Nouvelle-Aquitaine
    d %in% c("16", "17", "19", "23", "24", "33", "40", "47", "64", "79", "86", "87") ~ "Nouvelle-Aquitaine",
    
    # Centre-Val de Loire
    d %in% c("18", "28", "36", "37", "41", "45") ~ "Centre-Val de Loire",
    
    # Bourgogne-Franche-Comté
    d %in% c("21", "25", "39", "58", "70", "71", "89", "90") ~ "Bourgogne-Franche-Comté",
    
    # Bretagne
    d %in% c("22", "29", "35", "56") ~ "Bretagne",
    
    # Pays de la Loire
    d %in% c("44", "49", "53", "72", "85") ~ "Pays de la Loire",
    
    # Île-de-France
    d %in% c("75", "77", "78", "91", "92", "93", "94", "95") ~ "Île-de-France"
  )
}
```

```{r}
# Coefficients pour le calcul du score de sévérité
a <- 10
b <- 5
c <- 1

df <- df %>%
  # On transforme l'heure en un numeric compris entre 0 et 23
  # en extrayant la première partie de hrmn (heure:min)
  mutate(
    Heure_Num= as.numeric(str_sub(hrmn, 1, 2))
  ) %>%
  
  # On crée une variable Moment pour séparer les moments de la journée
  mutate(
    Moment = case_when(
      Heure_Num >= 0 & Heure_Num <= 5  ~ "Nuit Profonde",
      Heure_Num >= 6 & Heure_Num <= 10 ~ "Matin (Pointe)",
      Heure_Num >= 11 & Heure_Num <= 16 ~ "Journee (Creuse)",
      Heure_Num >= 17 & Heure_Num <= 21 ~ "Soir (Pointe)",
      Heure_Num >= 22 & Heure_Num <= 23 ~ "Soiree",
      TRUE ~ "Autre" # Sécurité
    ),
    # On transforme en factor et on choisit "Journée" comme référence
    Moment = factor(Moment, levels = c("Journée (Creuse)", "Matin (Pointe)", "Soir (Pointe)", "Soirée", "Nuit Profonde")))%>%
  
  # On crée la colonne région
  mutate(
    Region = get_region(dep),
    Region = as.factor(Region)
  ) %>%
  
  # On garde que les variables intéressantes i.e
  # en enlevant les identifiants (Num_Acc, adr), les variables quasi vides (pr, lartpc..), ou avec trop de catégories (com, dep)
  select(
    Region,
    Moment,
    lum, agg, int, atm, col, 
    catr, circ, prof, plan, surf, infra, situ, 
    vma, 
    nb_velo, nb_moto, nb_voiture, nb_utilitaire, nb_camion, nb_transport,
    nb_indemne, nb_tue, nb_hospitalise, nb_blesse
  ) %>%
  
    
  # On convertit les variables chr en factor pour que r les traitent comme des variables qualitatives
  mutate_if(is.character, as.factor) %>%
  
  # On supprime les lignes avec des valeurs manquantes
  na.omit

write.csv(df, "../data/donnees_clustering.csv", row.names = FALSE)
```
